<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3B82F6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="タスク記録">
  <title>タスク時間記録</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ⚠️ ここにFirebaseの設定を貼り付けてください ⚠️
    const firebaseConfig = {
  apiKey: "YOUR_API_KEY",  // ← ここを書き換え
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

    // Firebase初期化
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // アイコンコンポーネント
    const PlusIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const ClockIcon = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    );

    const CalendarIcon = () => (
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="mx-auto mb-3 opacity-50">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const TrendingUpIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const TrashIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );

    const UserIcon = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
    );

    const LogOutIcon = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    );

    const CloudIcon = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
      </svg>
    );

    function TaskTimeTracker() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [tasks, setTasks] = useState([]);
      const [taskName, setTaskName] = useState('');
      const [hours, setHours] = useState('');
      const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
      const [view, setView] = useState('week');
      const [syncing, setSyncing] = useState(false);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
          if (user) {
            loadTasksFromFirestore(user.uid);
          }
        });

        return () => unsubscribe();
      }, []);

      const signInWithGoogle = async () => {
        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await auth.signInWithPopup(provider);
        } catch (error) {
          console.error('ログインエラー:', error);
          alert('ログインに失敗しました: ' + error.message);
        }
      };

      const signOut = async () => {
        try {
          await auth.signOut();
          setTasks([]);
        } catch (error) {
          console.error('ログアウトエラー:', error);
        }
      };

      const loadTasksFromFirestore = async (userId) => {
        try {
          setSyncing(true);
          const snapshot = await db.collection('users').doc(userId).collection('tasks').get();
          const loadedTasks = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setTasks(loadedTasks);
        } catch (error) {
          console.error('データ読み込みエラー:', error);
        } finally {
          setSyncing(false);
        }
      };

      const addTask = async () => {
        if (!taskName || !hours || !date || !user) return;
        
        const newTask = {
          name: taskName,
          hours: parseFloat(hours),
          date: date,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
          setSyncing(true);
          const docRef = await db.collection('users').doc(user.uid).collection('tasks').add(newTask);
          setTasks([...tasks, { id: docRef.id, ...newTask }]);
          setTaskName('');
          setHours('');
        } catch (error) {
          console.error('保存エラー:', error);
          alert('保存に失敗しました');
        } finally {
          setSyncing(false);
        }
      };

      const deleteTask = async (id) => {
        if (!user) return;
        
        try {
          setSyncing(true);
          await db.collection('users').doc(user.uid).collection('tasks').doc(id).delete();
          setTasks(tasks.filter(t => t.id !== id));
        } catch (error) {
          console.error('削除エラー:', error);
          alert('削除に失敗しました');
        } finally {
          setSyncing(false);
        }
      };

      const getWeekNumber = (date) => {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      };

      const getWeekSummary = () => {
        const summary = {};
        tasks.forEach(task => {
          const taskDate = new Date(task.date);
          const year = taskDate.getFullYear();
          const week = getWeekNumber(task.date);
          const key = `${year}年 第${week}週`;
          
          if (!summary[key]) summary[key] = {};
          if (!summary[key][task.name]) summary[key][task.name] = 0;
          summary[key][task.name] += task.hours;
        });
        return summary;
      };

      const getMonthSummary = () => {
        const summary = {};
        tasks.forEach(task => {
          const taskDate = new Date(task.date);
          const key = `${taskDate.getFullYear()}年${taskDate.getMonth() + 1}月`;
          
          if (!summary[key]) summary[key] = {};
          if (!summary[key][task.name]) summary[key][task.name] = 0;
          summary[key][task.name] += task.hours;
        });
        return summary;
      };

      const getYearSummary = () => {
        const summary = {};
        tasks.forEach(task => {
          const taskDate = new Date(task.date);
          const key = `${taskDate.getFullYear()}年`;
          
          if (!summary[key]) summary[key] = {};
          if (!summary[key][task.name]) summary[key][task.name] = 0;
          summary[key][task.name] += task.hours;
        });
        return summary;
      };

      const renderSummary = () => {
        let summary;
        if (view === 'week') summary = getWeekSummary();
        else if (view === 'month') summary = getMonthSummary();
        else summary = getYearSummary();

        return Object.keys(summary).sort().reverse().map(period => {
          const totalHours = Object.values(summary[period]).reduce((a, b) => a + b, 0);
          return (
            <div key={period} className="bg-white rounded-lg p-4 shadow mb-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-bold text-lg text-gray-800">{period}</h3>
                <span className="text-sm text-gray-600 font-semibold">合計: {totalHours.toFixed(1)}h</span>
              </div>
              <div className="space-y-2">
                {Object.entries(summary[period])
                  .sort((a, b) => b[1] - a[1])
                  .map(([name, hours]) => (
                    <div key={name} className="flex justify-between items-center py-1 border-b border-gray-100 last:border-0">
                      <span className="text-gray-700">{name}</span>
                      <span className="text-blue-600 font-medium">{hours.toFixed(1)}h</span>
                    </div>
                  ))}
              </div>
            </div>
          );
        });
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-gray-600">読み込み中...</div>
          </div>
        );
      }

      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full text-center">
              <ClockIcon />
              <h1 className="text-3xl font-bold text-gray-800 mb-2 mt-4">タスク時間記録</h1>
              <p className="text-gray-600 mb-6">Googleアカウントでログインして、全端末でデータを同期</p>
              <button
                onClick={signInWithGoogle}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg flex items-center justify-center gap-2 transition-colors"
              >
                <UserIcon />
                Googleでログイン
              </button>
              <p className="text-xs text-gray-500 mt-4">
                ログインすると、iPhone、PC、Androidなど<br/>全ての端末でデータが同期されます
              </p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
          <div className="max-w-4xl mx-auto">
            <div className="bg-white rounded-xl shadow-lg p-4 mb-6 flex items-center justify-between">
              <div className="flex items-center gap-3">
                {user.photoURL && (
                  <img src={user.photoURL} alt="" className="w-10 h-10 rounded-full" />
                )}
                <div>
                  <div className="font-medium text-gray-800">{user.displayName}</div>
                  <div className="text-xs text-gray-500 flex items-center gap-1">
                    <CloudIcon />
                    {syncing ? '同期中...' : 'クラウド同期済み'}
                  </div>
                </div>
              </div>
              <button
                onClick={signOut}
                className="text-gray-600 hover:text-gray-800 flex items-center gap-2 text-sm"
              >
                <LogOutIcon />
                ログアウト
              </button>
            </div>
            
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                <ClockIcon />
                タスク時間記録
              </h1>
              <p className="text-gray-600 text-sm mb-2">後から振り返って作業時間を記録しましょう</p>
              <p className="text-green-600 text-xs font-medium">✓ 全端末で自動同期</p>
              
              <div className="space-y-4 mt-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">タスク名</label>
                  <input
                    type="text"
                    value={taskName}
                    onChange={(e) => setTaskName(e.target.value)}
                    placeholder="例: プロジェクトA作業"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">作業時間（時間）</label>
                    <input
                      type="number"
                      step="0.5"
                      value={hours}
                      onChange={(e) => setHours(e.target.value)}
                      placeholder="2.5"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">日付</label>
                    <input
                      type="date"
                      value={date}
                      onChange={(e) => setDate(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                </div>
                
                <button
                  onClick={addTask}
                  disabled={syncing}
                  className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 rounded-lg flex items-center justify-center gap-2 transition-colors"
                >
                  <PlusIcon />
                  記録を追加
                </button>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <div className="flex gap-2 mb-4">
                <button
                  onClick={() => setView('week')}
                  className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
                    view === 'week' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  週次
                </button>
                <button
                  onClick={() => setView('month')}
                  className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
                    view === 'month' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  月次
                </button>
                <button
                  onClick={() => setView('year')}
                  className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
                    view === 'year' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  年次
                </button>
              </div>
              
              <div className="flex items-center gap-2 mb-4">
                <TrendingUpIcon />
                <h2 className="text-xl font-bold text-gray-800">集計結果</h2>
              </div>
              
              {tasks.length === 0 ? (
                <div className="text-center py-12 text-gray-400">
                  <CalendarIcon />
                  <p>まだ記録がありません</p>
                </div>
              ) : (
                renderSummary()
              )}
            </div>

            {tasks.length > 0 && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-bold text-gray-800 mb-4">最近の記録</h2>
                <div className="space-y-2">
                  {[...tasks].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10).map(task => (
                    <div key={task.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="flex-1">
                        <div className="font-medium text-gray-800">{task.name}</div>
                        <div className="text-sm text-gray-500">{task.date}</div>
                      </div>
                      <div className="flex items-center gap-3">
                        <span className="font-bold text-blue-600">{task.hours}h</span>
                        <button
                          onClick={() => deleteTask(task.id)}
                          disabled={syncing}
                          className="text-red-500 hover:text-red-700 disabled:text-gray-400 transition-colors"
                        >
                          <TrashIcon />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<TaskTimeTracker />);
  </script>
</body>
</html>